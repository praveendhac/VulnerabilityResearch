#!C:\Python27\python.exe

import sys,os
from _winreg import *
import win32com.client
import glob

Registry = ConnectRegistry(None, HKEY_CLASSES_ROOT)
RawKey = OpenKey(Registry, "CLSID")
print "RawKey"
print(type(RawKey).__name__)
print(type(RawKey).__doc__)
print "EnumValue"
print(EnumValue.__doc__)

rtf_sample_data = """{\\rtf1{\object\objemb{\*\objclass None}{\*\oleclsid \'8d42060D99-fe53-41a2-1111-234511112222\'7d}{\*\objdata 010500000100000001000000000000000000000000000000000000000000000000000000000000000000000000}}}"""

rtf_split = rtf_sample_data.split("'")

clsid_list = []
rtf_data = []
total_clsids=0
fname = ""

try:
    i = 0
    print "Getting CLSID's and rtf data"
    while 1:
    	fname = ""
        cid_name = EnumKey(RawKey, i)
        #print "cid_name: ", cid_name
        cid = str((cid_name.replace("{","")).replace("}",""))
        #print "cid: ", cid        
        appen_str= str(rtf_split[0]) + "\\\'7b" + cid +"\\\'" + str(rtf_split[2])
        #print "appen_str:%s, len=%d" %(appen_str, len(appen_str))
        clsid_list.append(cid)
        rtf_data.append(appen_str)
        #skey = OpenKey(RawKey, cid)
        #n,v,t = EnumValue(skey,i)
        #print n,v,t
        i += 1
        total_clsids +=1
        fname = cid+".rtf"
        
        with open(fname, "w+") as f:
        	f.write(appen_str)
except WindowsError:
    print "exception!"
    pass
CloseKey(RawKey)

print "total_clsids:", total_clsids
print "total_clsids=len(clsid_list):", len(clsid_list)
print "Done!"  
print "rtf_sample_data:", rtf_sample_data
rtf_split = rtf_sample_data.split("'")

appen_str= str(rtf_split[0]) + "'" + str(rtf_split[1])+"'" + str(rtf_split[2])

print "appen_str:%s,len:%d" %(appen_str,len(appen_str))
print "len rtf_sample_data=", len(rtf_sample_data)
print "len rtf_data=", len(rtf_data)

if appen_str == rtf_sample_data:
	print "Equal strings!"

print "reading all *.rtf files at C:\Python27\rtf_malicious"
rtf_file_list = glob.glob("C:\\Python27\\rtf_malicious\\*.rtf")
print rtf_file_list
print "len rtf_file_list:", len(rtf_file_list)

for rfile in rtf_file_list:
	MSWord = win32com.client.Dispatch("Word.Application")
	MSWord.Visible = 0
	print "Opening file:", rfile
	try:
		MSWord.Documents.Open(rfile)
	except:
		pass
	print "Closing file:", rfile
	MSWord.Documents.Close()
print "Done Opening/Closing all RTF files"	

