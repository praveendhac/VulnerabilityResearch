#!/usr/bin/python

import sys,os
import csv,subprocess

#msfcli exploit/linux/http/ddwrt_cgibin_exec S
wrow = []
def main(args):
	global wrow
	cve = " "
	sid = " "
	osvdb = " "
	ids_array = []

	print "Parsing " + args[1]
	msfcsv = open(args[1], 'rb')
	rows = csv.reader(msfcsv)

	idscsv = open("exp_all_ids.csv", 'wb')
	write_rows = csv.writer(idscsv, dialect='excel')

	for row in rows:
		print row
		print "<<<<**********************************************>>>>"
		print "row[0]:"
		print row[0]
		print "**********************************************"
		p = subprocess.Popen(['/usr/bin/msfcli', row[0], 'S'],stdout=subprocess.PIPE)
		(out,err) = p.communicate()
		status = p.wait()

		print "output:" + out
		print "status/return code:" + str(status)
		out_stripped = out.strip()
		outnew = out_stripped.split('\n')
		references =  outnew[-6:]
		print ">>>>references"
		print references
		for line in references:
			if "cve" in line:
				id = line.split("/")
				if id[-1]:
					print "CVE id[-1]:" + str(id[-1])
					cve =  str(id[-1])
				else:
					print "CVE id[-2]:" + str(id[-2])
					cve =  str(id[-2])

			if "securityfocus" in line:
				id = line.split("/")
				print "sid id[-1]:" + str(id[-1])
				sid = str(id[-1])
			if "osvdb" in line:
				id = line.split("/")
				print "osvdb id[-1]:" + str(id[-1])
				osvdb = str(id[-1])

		print "row[1]:"
		print row[1]
		
		wrow = [row[0],row[1],cve,sid,osvdb]
		ids_array.append(wrow)
		print ">>>>wrow:"
		print wrow
		write_rows.writerows([wrow])
		print "ids_array:"
		print ids_array
		print "<<<<<<<<write_rows:"
		print write_rows
		print "+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+"
	idscsv.close()
	msfcsv.close()

if __name__== "__main__":
	main(sys.argv)
